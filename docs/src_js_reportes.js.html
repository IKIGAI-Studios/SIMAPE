<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/js/reportes.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/js/reportes.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import SnackBar from "./componentes/snackbar.js";
import { ModalReporte } from "./modalsAd.js";
import { buscarExpediente } from "./actions/accionesExpediente.js";
import { buscarUsuario } from "./actions/accionesUsuario.js"
import { obtenerMovimientosFecha, obtenerMovimientosExpediente, obtenerMovimientosUsuario } from "./actions/accionesMovimiento.js";
import { generarExcel } from "./test/testExcel.js";

const snackbar = new SnackBar(document.querySelector('#snackbar'));

const fromMesReporte = document.querySelector('#fromMesReporte');
const toMesReporte = document.querySelector('#toMesReporte');
const tipoPensionReporte = document.querySelector('#tipoPensionReporte');
const checkboxReporte = document.querySelector('#checkboxReporte');
const btnGenerarReporteFecha = document.querySelector('#btnGenerarReporteFecha');
const btnGenerarReporteFechaExcel = document.querySelector('#btnGenerarReporteFechaExcel');

const nssReportes = document.querySelector('#nssReportes');
const btnGenerarReporteExpediente = document.querySelector('#btnGenerarReporteExpediente');
const btnGenerarReporteExpedienteExcel = document.querySelector('#btnGenerarReporteExpedienteExcel');

const matriculaReportes = document.querySelector('#matriculaReportes');
const btnGenerarReporteUsuario = document.querySelector('#btnGenerarReporteUsuario');
const btnGenerarReporteUsuarioExcel = document.querySelector('#btnGenerarReporteUsuarioExcel');

const bodyModalReporte = document.querySelector('#modalReporte div.row');

class Reporte {
    constructor(HTMLelement) {
        this.HTMLelement = HTMLelement;
    }

    addTitle(title) {
        this.HTMLelement.innerHTML += `&lt;h2>${title}&lt;/h2>`;
    }

    addText(text) {
        this.HTMLelement.innerHTML += `&lt;p>${text}&lt;/p>`;
    }

    /**
     * 
     * @param {String} id 
     * @param {Array&lt;String>} columns 
     * @param {Array&lt;Array&lt;String>>} rows 
     */
    addTable(id, nombre, columns, rows) {
        this.HTMLelement.innerHTML += `
        &lt;table class="tabla" id="${id}" nombre="${nombre}">
            &lt;thead>
                ${
                    columns.map((column) => {
                        return `&lt;th>${column}&lt;/th>` 
                    }).join('')
                }
            &lt;/thead>
            &lt;tbody>
                ${
                    rows.map((row) => {
                        return `&lt;tr>${
                            row.map((cell) => {
                                return `&lt;td>${cell}&lt;/td>` 
                            }).join('')
                        }&lt;/tr>` 
                    }).join('')
                }
            &lt;/tbody>
        &lt;/table>
        `;
    }
}

btnGenerarReporteFecha.addEventListener('click', async () => {

    const fechaInicio = new Date(fromMesReporte.value);
    const fechaFin = new Date(toMesReporte.value);

    const ultimoDiaMesActual = new Date(fechaFin.getFullYear(), fechaFin.getMonth() + 2, 1);

    if (fechaInicio > fechaFin || fromMesReporte.value == '' || toMesReporte.value == '') {
        return snackbar.showError('Error en el rango de fecha');
    }

    const tipos = Array.from(checkboxReporte.getElementsByTagName('input')).map((chk) => {
        return chk.checked ? chk.value : null
    }).filter(Boolean);

    if (!tipos.length) {
        return snackbar.showError('Escoge al menos un tipo de movimiento');
    }

    await generarReporteFecha(fechaInicio, ultimoDiaMesActual, tipoPensionReporte.value, tipos);
});

btnGenerarReporteFechaExcel.addEventListener('click', async () => {
    const fechaInicio = new Date(fromMesReporte.value);
    const fechaFin = new Date(toMesReporte.value);

    const ultimoDiaMesActual = new Date(fechaFin.getFullYear(), fechaFin.getMonth() + 2, 1);

    if (fechaInicio > fechaFin || fromMesReporte.value == '' || toMesReporte.value == '') {
        return snackbar.showError('Error en el rango de fecha');
    }

    const tipos = Array.from(checkboxReporte.getElementsByTagName('input')).map((chk) => {
        return chk.checked ? chk.value : null
    }).filter(Boolean);

    if (!tipos.length) {
        return snackbar.showError('Escoge al menos un tipo de movimiento');
    }

    await generarReporteFecha(fechaInicio, ultimoDiaMesActual, tipoPensionReporte.value, tipos);
    generarExcel(bodyModalReporte);
});

btnGenerarReporteExpediente.addEventListener('click', async () => {
    if (nssReportes.value == '') {
        snackbar.showError('Introduca un NSS de expediente');
        return;
    }

    await generarReporteExpediente(nssReportes.value);
});

btnGenerarReporteExpedienteExcel.addEventListener('click', async () => {
    if (nssReportes.value == '') {
        snackbar.showError('Introduca un NSS de expediente');
        return;
    }

    await generarReporteExpediente(nssReportes.value);
    generarExcel(bodyModalReporte);
});

btnGenerarReporteUsuario.addEventListener('click', async () => {
    if (matriculaReportes.value == '') {
        snackbar.showError('Introduca una matricula válida');
        return;
    }

    await generarReporteUsuario(matriculaReportes.value);
});

btnGenerarReporteUsuarioExcel.addEventListener('click', async () => {
    if (matriculaReportes.value == '') {
        snackbar.showError('Introduca una matricula válida');
        return;
    }

    await generarReporteUsuario(matriculaReportes.value);
    generarExcel(bodyModalReporte);
});

async function generarReporteFecha(fechaInicio, fechaFin, categoria, tipos) {
    bodyModalReporte.innerHTML = '';
    
    const movimientos = await obtenerMovimientosFecha(fechaInicio, fechaFin, categoria, tipos);

    if (movimientos instanceof Error) {
        return snackbar.showError(movimientos.message);
    }

    console.log(movimientos);
    
    const reporte = new Reporte(bodyModalReporte);

    ModalReporte.enable();

    reporte.addTitle('INFORMACIÓN GENERAL');
    reporte.addText(`Fecha inicio: ${fechaInicio.toLocaleString()}`);
    reporte.addText(`Fecha fin: ${fechaFin.toLocaleString()}`);
    reporte.addText(`Categoría: ${categoria}`);
    reporte.addText(`Tipos: ${tipos.toString()}`);
    
    if (movimientos.altas &amp;&amp; movimientos.altas.length) {
        reporte.addTitle('ALTAS');
        const movimientosAlta = movimientos.altas.map((alta) => {
            return [
                alta.folio,
                new Date(alta.fecha).toLocaleString(),
                alta.nss,
                `${alta.nombre} ${alta.apellidos}`
            ]
        });
        reporte.addTable('tablaAltaReporte', 'ALTAS', ['FOLIO', 'FECHA', 'NSS', 'USUARIO'], movimientosAlta);
    }

    if (movimientos.bajas &amp;&amp; movimientos.bajas.length) {
        reporte.addTitle('BAJAS');
        const movimientosBaja = movimientos.bajas.map((baja) => {
            return [
                baja.folio,
                new Date(baja.fecha).toLocaleString(),
                baja.nss,
                `${baja.nombre} ${baja.apellidos}`
            ]
        });
        reporte.addTable('tablaBajaReporte', 'BAJAS', ['FOLIO', 'FECHA', 'NSS', 'USUARIO'], movimientosBaja);
    }

    if (movimientos.transferencias &amp;&amp; movimientos.transferencias.length) {
        reporte.addTitle('TRANSFERENCIAS');
        const movimientosBaja = movimientos.transferencias.map((transferencia) => {
            return [
                transferencia.folio,
                new Date(transferencia.fecha).toLocaleString(),
                transferencia.nss,
                `${transferencia.nombre} ${transferencia.apellidos}`,
                `${transferencia.n_delegacion} ${transferencia.nom_delegacion} ${transferencia.n_subdelegacion} ${transferencia.nom_subdelegacion}`
            ]
        });
        reporte.addTable('tablaTransferenciaReporte', 'TRANSFERENCIAS', ['FOLIO', 'FECHA', 'NSS', 'USUARIO', 'DESTINO'], movimientosBaja);
    }
}

async function generarReporteExpediente(nss) {
    bodyModalReporte.innerHTML = '';
    
    let expediente = await buscarExpediente(nss);
    const movimientos = await obtenerMovimientosExpediente(nss);

    if (expediente instanceof Error) {
        return snackbar.showError('Introduca un NSS válido');
    }

    expediente = expediente.expediente;
    
    const reporte = new Reporte(bodyModalReporte);

    ModalReporte.enable();

    reporte.addTitle('INFORMACIÓN GENERAL');
    reporte.addText(`Numero de expediente: ${expediente.nss}`);
    reporte.addText(`Nombre: ${expediente.nombre}`);
    reporte.addText(`Categoría de pensión: ${expediente.categoria}`);
    reporte.addText(`Año: ${expediente.año}`);
    reporte.addText(`Observaciones: ${expediente.observaciones ?? 'Ninguna'}`);
    reporte.addText(`Ubicación: ${expediente.ubicacion}`);
    
    reporte.addTitle('ALTA');
    reporte.addTable('tablaAltaReporte', 'ALTA', ['FOLIO', 'FECHA', 'REGISTRADO POR'], [[movimientos.alta.folio, new Date(movimientos.alta.fecha).toLocaleString(), `${movimientos.alta.nombre} ${movimientos.alta.apellidos}`]]);
    
    if (movimientos.baja) {
        reporte.addTitle('BAJA');
        reporte.addTable('tablaBajaReporte', 'BAJA', ['FOLIO', 'FECHA', 'DADO DE BAJA POR'], [[movimientos.baja.folio, new Date(movimientos.baja.fecha).toLocaleString(), `${movimientos.baja.nombre} ${movimientos.baja.apellidos}`]]);
    }

    if (movimientos.transferencia) {
        reporte.addTitle('TRANSFERENCIA');
        reporte.addTable('tablaTransferenciaReporte', 'TRANSFERENCIA', ['FOLIO', 'FECHA', 'TRANSFERIDO POR', 'DESTINO'], [[movimientos.transferencia.folio, new Date(movimientos.transferencia.fecha).toLocaleString(), `${movimientos.transferencia.nombre} ${movimientos.transferencia.apellidos}`, `${movimientos.transferencia.n_delegacion} ${movimientos.transferencia.nom_delegacion} ${movimientos.transferencia.n_subdelegacion} ${movimientos.transferencia.nom_subdelegacion}`]]);
    }

    if (movimientos.extracciones &amp;&amp; movimientos.extracciones.length) {
        reporte.addTitle('EXTRACCIONES');
        const movimientosExtraccion = movimientos.extracciones.map((extraccion) => {
            return [
                extraccion.folio,
                new Date(extraccion.fecha).toLocaleString(),
                `${extraccion.nombre} ${extraccion.apellidos}`
            ]
        });
        reporte.addTable('tablaExtraccionesReporte', 'EXTRACCIONES', ['FOLIO', 'FECHA', 'USUARIO'], movimientosExtraccion);
    }

    if (movimientos.ingresos &amp;&amp; movimientos.ingresos.length) {
        reporte.addTitle('INGRESOS');
        const movimientosIngreso = movimientos.ingresos.map((ingreso) => {
            return [
                ingreso.folio,
                new Date(ingreso.fecha).toLocaleString(),
                `${ingreso.nombre} ${ingreso.apellidos}`
            ]
        });
        reporte.addTable('tablaIngresosReporte', 'INGRESOS', ['FOLIO', 'FECHA', 'USUARIO'], movimientosIngreso);
    }

    if (movimientos.prestamos &amp;&amp; movimientos.prestamos.length) {
        reporte.addTitle('PRÉSTAMOS');
        const movimientosPrestamo = movimientos.prestamos.map((prestamo) => {
            return [
                prestamo.folio,
                new Date(prestamo.fecha).toLocaleString(),
                `${prestamo.nombre} ${prestamo.apellidos}`,
                `${prestamo.receptor_nombre} ${prestamo.receptor_apellidos}`,
                `${prestamo.pendiente ? 'PENDIENTE' : 'FINALIZADO'}`,
                `${prestamo.pendiente ? '' : new Date(prestamo.fecha_finalizacion).toLocaleString()}`
            ]
        });

        reporte.addTable('tablaPrestamosReporte', 'PRÉSTAMOS', [
            'FOLIO', 
            'FECHA EMISIÓN', 
            'USUARIO EMISOR', 
            'USUARIO RECEPTOR', 
            'ESTADO', 
            'FECHA_RECEPCIÓN'
        ], movimientosPrestamo);
    }

    if (movimientos.supervisiones &amp;&amp; movimientos.supervisiones.length) {
        reporte.addTitle('SUPERVISIONES');
        const movimientosSupervision = movimientos.supervisiones.map((supervision) => {
            return [
                supervision.folio,
                new Date(supervision.fecha).toLocaleString(),
                `${supervision.nombre} ${supervision.apellidos}`,
                supervision.supervisor,
                `${supervision.pendiente ? 'PENDIENTE' : 'FINALIZADO'}`,
                `${supervision.pendiente ? '' : new Date(supervision.fecha_finalizacion).toLocaleString()}`
            ]
        });

        reporte.addTable('tablaSupervisionesReporte', 'SUPERVISIONES', [
            'FOLIO',
            'FECHA', 
            'RESPONSABLE', 
            'SUPERVISOR', 
            'ESTADO', 
            'FECHA_FINALIZACIÓN'
        ], movimientosSupervision);
    }
}

async function generarReporteUsuario(matricula) {
    bodyModalReporte.innerHTML = '';
    
    const usuario = await buscarUsuario(matricula);
    const movimientos = await obtenerMovimientosUsuario(matricula);

    if (usuario instanceof Error) {
        return snackbar.showError(usuario.message);
    }
    
    const reporte = new Reporte(bodyModalReporte);

    ModalReporte.enable();

    reporte.addTitle('INFORMACIÓN GENERAL');
    reporte.addText(`Matricula: ${usuario.matricula}`);
    reporte.addText(`Nombre: ${usuario.nombre} ${usuario.apellidos}`);
    reporte.addText(`Registro: ${new Date(usuario.fecha_registro).toLocaleString()}`);
    reporte.addText(`Adscripción: ${usuario.adscripcion}`);
    
    if (movimientos.altas &amp;&amp; movimientos.altas.length) {
        reporte.addTitle('ALTAS');
        const movimientosAlta = movimientos.altas.map((alta) => {
            return [
                alta.folio,
                new Date(alta.fecha).toLocaleString(),
                alta.nss
            ]
        });
        reporte.addTable('tablaAltaReporte', 'ALTAS', ['FOLIO', 'FECHA', 'NSS'], movimientosAlta);
    }

    if (movimientos.bajas &amp;&amp; movimientos.bajas.length) {
        reporte.addTitle('BAJAS');
        const movimientosBaja = movimientos.bajas.map((baja) => {
            return [
                baja.folio,
                new Date(baja.fecha).toLocaleString(),
                baja.nss
            ]
        });
        reporte.addTable('tablaBajaReporte', 'BAJAS', ['FOLIO', 'FECHA', 'NSS'], movimientosBaja);
    }

    if (movimientos.transferencias &amp;&amp; movimientos.transferencias.length) {
        reporte.addTitle('TRANSFERENCIAS');
        const movimientosBaja = movimientos.transferencias.map((transferencia) => {
            return [
                transferencia.folio,
                new Date(transferencia.fecha).toLocaleString(),
                transferencia.nss,
                `${transferencia.n_delegacion} ${transferencia.nom_delegacion} ${transferencia.n_subdelegacion} ${transferencia.nom_subdelegacion}`
            ]
        });
        reporte.addTable('tablaTransferenciaReporte', 'TRANSFERENCIAS', ['FOLIO', 'FECHA', 'NSS', 'DESTINO'], movimientosBaja);
    }

    if (movimientos.extracciones &amp;&amp; movimientos.extracciones.length) {
        reporte.addTitle('EXTRACCIONES');
        const movimientosExtraccion = movimientos.extracciones.map((extraccion) => {
            return [
                extraccion.folio,
                new Date(extraccion.fecha).toLocaleString(),
                extraccion.nss
            ]
        });
        reporte.addTable('tablaExtraccionesReporte', 'EXTRACCIONES', ['FOLIO', 'FECHA', 'NSS'], movimientosExtraccion);
    }

    if (movimientos.ingresos &amp;&amp; movimientos.ingresos.length) {
        reporte.addTitle('INGRESOS');
        const movimientosIngreso = movimientos.ingresos.map((ingreso) => {
            return [
                ingreso.folio,
                new Date(ingreso.fecha).toLocaleString(),
                ingreso.nss
            ]
        });
        reporte.addTable('tablaIngresosReporte', 'INGRESOS', ['FOLIO', 'FECHA', 'NSS'], movimientosIngreso);
    }

    if (movimientos.prestamos &amp;&amp; movimientos.prestamos.length) {
        reporte.addTitle('PRÉSTAMOS');
        const movimientosPrestamo = movimientos.prestamos.map((prestamo) => {
            return [
                prestamo.folio,
                new Date(prestamo.fecha).toLocaleString(),
                `${prestamo.nombre} ${prestamo.apellidos}`,
                `${prestamo.receptor_nombre} ${prestamo.receptor_apellidos}`,
                `${prestamo.pendiente ? 'PENDIENTE' : 'FINALIZADO'}`,
                `${prestamo.pendiente ? '' : new Date(prestamo.fecha_finalizacion).toLocaleString()}`
            ]
        });

        reporte.addTable('tablaPrestamosReporte', 'PRÉSTAMOS', [
            'FOLIO', 
            'FECHA EMISIÓN', 
            'USUARIO EMISOR', 
            'USUARIO RECEPTOR', 
            'ESTADO', 
            'FECHA_RECEPCIÓN'
        ], movimientosPrestamo);
    }

    if (movimientos.supervisiones &amp;&amp; movimientos.supervisiones.length) {
        reporte.addTitle('SUPERVISIONES');
        const movimientosSupervision = movimientos.supervisiones.map((supervision) => {
            return [
                supervision.folio,
                new Date(supervision.fecha).toLocaleString(),
                supervision.nss,
                supervision.supervisor,
                `${supervision.pendiente ? 'PENDIENTE' : 'FINALIZADO'}`,
                `${supervision.pendiente ? '' : new Date(supervision.fecha_finalizacion).toLocaleString()}`
            ]
        });

        reporte.addTable('tablaSupervisionesReporte', 'SUPERVISIONES', [
            'FOLIO',
            'FECHA', 
            'NSS', 
            'SUPERVISOR', 
            'ESTADO', 
            'FECHA_FINALIZACIÓN'
        ], movimientosSupervision);
    }
}



</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#actualizarUsuarios">actualizarUsuarios</a></li><li><a href="global.html#a%25C3%25B1osFill">añosFill</a></li><li><a href="global.html#clearInputs">clearInputs</a></li><li><a href="global.html#crearFilaDeUsuario">crearFilaDeUsuario</a></li><li><a href="global.html#fillUsers">fillUsers</a></li><li><a href="global.html#handleBajaUsuario">handleBajaUsuario</a></li><li><a href="global.html#handleEditarUsuario">handleEditarUsuario</a></li><li><a href="global.html#handleRecuperarUsuario">handleRecuperarUsuario</a></li><li><a href="global.html#handleReimprimir">handleReimprimir</a></li><li><a href="global.html#listDelegacionesFill">listDelegacionesFill</a></li><li><a href="global.html#obtenerMisDatos">obtenerMisDatos</a></li><li><a href="global.html#obtenerNumeroFolio">obtenerNumeroFolio</a></li><li><a href="global.html#rellenarDatos">rellenarDatos</a></li><li><a href="global.html#resetValues">resetValues</a></li><li><a href="global.html#socketsUsuario">socketsUsuario</a></li><li><a href="global.html#subirArchivo">subirArchivo</a></li><li><a href="global.html#validarCampos">validarCampos</a></li><li><a href="global.html#validarCamposAgregar">validarCamposAgregar</a></li><li><a href="global.html#validarCamposEditar">validarCamposEditar</a></li><li><a href="global.html#validarUsuario">validarUsuario</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Wed Aug 09 2023 19:23:19 GMT-0600 (hora estándar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
